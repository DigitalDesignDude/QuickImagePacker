<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="style.css">
    <title>Quick Image Packer</title>
</head>

<body>
    <div id="header">
        <!--INTRO INFORMATION -->
        <h1>Quick Image Packer</h1>
        <p>A simple web app for combining multiple uploaded images into a single image, sprite sheet, or texture atlas.</p>

        <!--CONTROLS-->
        <div style="margin-bottom: 30px;">

            <input type="file" id="imageInput" accept="image/*" multiple>
            <label for="rows">Rows:</label>
            <input class="input-field" type="number" id="rows" min="1" value="3" oninput="arrangeImages()">
            <label for="columns">Columns:</label>
            <input class="input-field" type="number" id="columns" min="1" value="3" oninput="arrangeImages()">
            <label>
                <input type="checkbox" class="checkbox" id="zig-toggler" oninput="arrangeImages()">
                Zig Zag Order
            </label>
        </div>

        <!--CROPPING CONTROLS-->
        <div style="margin-bottom: 30px;">
            <h2>Crop Settings</h2>
            <label for="cropTop">Top:</label>
            <input class="input-field" type="number" id="cropTop" min="0" value="0" oninput="arrangeImages()">
            <label for="cropBottom">Bottom:</label>
            <input class="input-field" type="number" id="cropBottom" min="0" value="0" oninput="arrangeImages()">
            <label for="cropLeft">Left:</label>
            <input class="input-field" type="number" id="cropLeft" min="0" value="0" oninput="arrangeImages()">
            <label for="cropRight">Right:</label>
            <input class="input-field" type="number" id="cropRight" min="0" value="0" oninput="arrangeImages()">
        </div>
        <div>
            <button id="downloadButton">Download Combined Image</button>
        </div>
    </div>

    <!--Image Canvas-->
    <div class="canvas-container">
        <canvas id="imageCanvas"></canvas>
    </div>

    <script>
        document.getElementById('imageInput').addEventListener('change', handleFileSelect);
        document.getElementById('downloadButton').addEventListener('click', downloadCombinedImage);

        //Array to Store all the images in
        let images = [];
        let loadedImages = 0;

        function handleFileSelect(event) {
            const files = event.target.files;

            if (!files || files.length === 0) {
                return;
            }

            // Reset the images array everytime images are uploaded
            images = [];

            //Sort images in order of filename and arrange them after they have all been loaded
            images = Array.from(files).sort((a, b) => a.name.localeCompare(b.name))
                .map(file => {
                    const img = new Image();
                    img.onload = function() {
                        loadedImages++;
                        if (loadedImages === images.length) {
                            arrangeImages();
                        }
                    };
                    img.src = URL.createObjectURL(file);
                    return img;
                });
        }

        function arrangeImages() {
            //Get References to all the Control Settings
            const rows = parseInt(document.getElementById('rows').value, 10);
            const columns = parseInt(document.getElementById('columns').value, 10);
            const cropTop = parseInt(document.getElementById('cropTop').value, 10);
            const cropBottom = parseInt(document.getElementById('cropBottom').value, 10);
            const cropLeft = parseInt(document.getElementById('cropLeft').value, 10);
            const cropRight = parseInt(document.getElementById('cropRight').value, 10);


            const imageCanvas = document.getElementById('imageCanvas');
            const context = imageCanvas.getContext('2d');

            let imageWidth = images[0].naturalWidth - cropLeft - cropRight;
            let imageHeight = images[0].naturalHeight - cropTop - cropBottom;

            // Set canvas size to fit all images based on one's actual image file dimensions
            imageCanvas.width = columns * imageWidth;
            imageCanvas.height = rows * imageHeight;

            // Draw each image onto the canvas based on the arranged layout
            let currentX = 0;
            let currentY = 0;
            let ReverseX = false;

            for (let i = 0; i < rows; i++) {

                //Reserve Row Direction if enabled
                if (ReverseX == true && document.getElementById('zig-toggler').checked) {
                    //Create images Going Left
                    for (let j = 0; j < columns; j++) {
                        const imgIndex = i * columns + j;
                        if (imgIndex < images.length) {

                            //Draw the Image to the canvas at the proper position and cropping using the draw image clipping method
                            const img = images[imgIndex];

                            context.drawImage(img,
                                cropLeft,
                                cropTop,
                                img.width - cropLeft - cropRight,
                                img.height - cropTop - cropBottom,
                                imageWidth * (columns - 1) - j * imageWidth,
                                i * imageHeight,
                                img.width - cropLeft - cropRight,
                                img.height - cropTop - cropBottom
                            );
                        }
                        //Signify Reverse Direction
                        if (j == 0) {
                            ReverseX = false;
                            //console.log("Reverse false");
                        }
                    }
                } else {
                    //Create images Going Right
                    for (let j = 0; j < columns; j++) {
                        const imgIndex = i * columns + j;
                        if (imgIndex < images.length) {

                            const img = images[imgIndex];

                            context.drawImage(img,
                                cropLeft,
                                cropTop,
                                img.width - cropLeft - cropRight,
                                img.height - cropTop - cropBottom,
                                j * imageWidth,
                                i * imageHeight,
                                img.width - cropLeft - cropRight,
                                img.height - cropTop - cropBottom
                            );
                        }
                        //Signify Reverse Direction
                        if (j == columns - 1) {
                            ReverseX = true;
                            //console.log("Reverse true");
                        }
                    }
                }
            }
        }

        function downloadCombinedImage() {

            // Convert canvas to data URL and create a download link
            const imageCanvas = document.getElementById('imageCanvas');
            const combinedDataURL = imageCanvas.toDataURL('image/png');
            const downloadLink = document.createElement('a');
            downloadLink.href = combinedDataURL;
            downloadLink.download = 'combined_image.png';
            downloadLink.click();
        }
    </script>
</body>

</html>